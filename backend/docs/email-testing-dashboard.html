<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UMSafe Email Testing Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }
    
    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    
    .header p {
      font-size: 1.2em;
      opacity: 0.9;
    }
    
    .setup-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .setup-card h2 {
      color: #667eea;
      margin-bottom: 15px;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
    }
    
    .input-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    .input-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .test-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .test-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .test-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .test-card h3 {
      color: #333;
      margin-bottom: 10px;
      font-size: 1.3em;
    }
    
    .test-card p {
      color: #666;
      margin-bottom: 15px;
      line-height: 1.5;
    }
    
    .test-button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.3s;
    }
    
    .test-button:hover {
      opacity: 0.9;
    }
    
    .test-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
      display: none;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }
    
    .status.loading {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
      display: block;
    }
    
    .test-all-btn {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      padding: 15px 30px;
      font-size: 18px;
      margin: 20px auto;
      display: block;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }
    
    .badge-new {
      background: #28a745;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìß UMSafe Email Testing Dashboard</h1>
      <p>Test all email notification events with one click</p>
    </div>
    
    <div class="setup-card">
      <h2>üîë Login to Get Token</h2>
      <div class="input-group">
        <label for="email">Email</label>
        <input type="email" id="email" placeholder="admin@example.com">
      </div>
      <div class="input-group">
        <label for="password">Password</label>
        <input type="password" id="password" placeholder="Your password">
      </div>
      <button class="test-button" onclick="login()" style="margin-bottom: 15px;">üîê Login & Get Token</button>
      <div class="status" id="login-status"></div>
    </div>
    
    <div class="setup-card">
      <h2>üîß Setup (Auto-filled after login)</h2>
      <div class="input-group">
        <label for="token">Authentication Token</label>
        <input type="text" id="token" placeholder="Will be filled after login" readonly style="background: #f5f5f5;">
      </div>
      <div class="input-group">
        <label for="staffId">Staff ID</label>
        <input type="text" id="staffId" placeholder="Will be filled after login" readonly style="background: #f5f5f5;">
      </div>
      <div class="input-group">
        <label for="baseUrl">Backend URL</label>
        <input type="text" id="baseUrl" value="http://localhost:5000" placeholder="http://localhost:5000">
      </div>
      <button class="test-button" onclick="getStaffList()" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">üë• Refresh Staff List</button>
    </div>
    
    <button class="test-button test-all-btn" onclick="testAll()">üöÄ Test All Notifications</button>
    
    <div class="test-grid">
      <div class="test-card">
        <h3>1Ô∏è‚É£ New Complaint <span class="badge badge-new">NEW</span></h3>
        <p>Tests email sent to all admins when a new complaint is created</p>
        <button class="test-button" onclick="testNewComplaint()">Test Now</button>
        <div class="status" id="status-1"></div>
      </div>
      
      <div class="test-card">
        <h3>2Ô∏è‚É£ Assignment</h3>
        <p>Tests email sent when staff is assigned to a complaint</p>
        <button class="test-button" onclick="testAssignment()">Test Now</button>
        <div class="status" id="status-2"></div>
      </div>
      
      <div class="test-card">
        <h3>3Ô∏è‚É£ Unassignment</h3>
        <p>Tests email sent when staff is removed from a complaint</p>
        <button class="test-button" onclick="testUnassignment()">Test Now</button>
        <div class="status" id="status-3"></div>
      </div>
      
      <div class="test-card">
        <h3>4Ô∏è‚É£ Resolved Status</h3>
        <p>Tests email sent when complaint is marked as resolved</p>
        <button class="test-button" onclick="testResolved()">Test Now</button>
        <div class="status" id="status-4"></div>
      </div>
      
      <div class="test-card">
        <h3>5Ô∏è‚É£ Closed Status</h3>
        <p>Tests email sent when complaint is marked as closed</p>
        <button class="test-button" onclick="testClosed()">Test Now</button>
        <div class="status" id="status-5"></div>
      </div>
      
      <div class="test-card">
        <h3>6Ô∏è‚É£ Reopened <span class="badge badge-new">NEW</span></h3>
        <p>Tests email sent when resolved/closed complaint is reopened</p>
        <button class="test-button" onclick="testReopened()">Test Now</button>
        <div class="status" id="status-6"></div>
      </div>
    </div>
  </div>
  
  <script>
    function showStatus(id, type, message) {
      const status = document.getElementById(`status-${id}`);
      status.className = `status ${type}`;
      status.textContent = message;
    }
    
    async function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const baseUrl = document.getElementById('baseUrl').value;
      const loginStatus = document.getElementById('login-status');
      
      if (!email || !password) {
        loginStatus.className = 'status error';
        loginStatus.textContent = '‚ùå Please enter email and password';
        return;
      }
      
      loginStatus.className = 'status loading';
      loginStatus.textContent = 'üîÑ Logging in...';
      
      try {
        const response = await fetch(`${baseUrl}/admin/auth/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        if (response.ok && data.token) {
          document.getElementById('token').value = data.token;
          document.getElementById('staffId').value = data.user.id || data.user._id;
          
          loginStatus.className = 'status success';
          loginStatus.textContent = `‚úÖ Logged in as ${data.user.name} (${data.user.role})`;
          
          // Auto-load staff list
          await getStaffList();
        } else {
          loginStatus.className = 'status error';
          loginStatus.textContent = '‚ùå Login failed: ' + (data.message || 'Invalid credentials');
        }
      } catch (error) {
        loginStatus.className = 'status error';
        loginStatus.textContent = '‚ùå Error: ' + error.message;
      }
    }
    
    async function getStaffList() {
      const token = document.getElementById('token').value;
      const baseUrl = document.getElementById('baseUrl').value;
      
      if (!token) {
        alert('Please login first to get your token!');
        return;
      }
      
      try {
        const response = await fetch(`${baseUrl}/admin/test-emails/staff-list`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (data.success && data.staff.length > 0) {
          // Show staff list in a formatted way
          const staffInfo = data.staff.map(s => 
            `${s.name} (${s.email}) - ${s.role} - ID: ${s.id}`
          ).join('\n');
          
          alert(`üìã Available Staff Members:\n\n${staffInfo}\n\n‚úÖ Using first staff member for tests`);
          
          // Set first staff member as default
          document.getElementById('staffId').value = data.staff[0].id;
        }
      } catch (error) {
        alert('Failed to load staff list: ' + error.message);
      }
    }
    
    async function makeRequest(endpoint, body) {
      const token = document.getElementById('token').value;
      const baseUrl = document.getElementById('baseUrl').value;
      
      if (!token) {
        alert('Please enter your authentication token first!');
        return null;
      }
      
      const response = await fetch(`${baseUrl}/admin/test-emails/${endpoint}`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });
      
      return response.json();
    }
    
    async function testNewComplaint() {
      showStatus(1, 'loading', 'üì§ Sending test email...');
      try {
        const result = await makeRequest('test-new-complaint', {
          complaintId: 'CMP-TEST-' + Date.now(),
          title: 'Test New Complaint from Dashboard'
        });
        
        if (result && result.success) {
          showStatus(1, 'success', '‚úÖ Email sent! Check inbox for all admins.');
        } else {
          showStatus(1, 'error', '‚ùå Failed: ' + (result?.message || 'Unknown error'));
        }
      } catch (error) {
        showStatus(1, 'error', '‚ùå Error: ' + error.message);
      }
    }
    
    async function testAssignment() {
      const staffId = document.getElementById('staffId').value;
      if (!staffId) {
        showStatus(2, 'error', '‚ùå Please enter Staff ID first!');
        return;
      }
      
      showStatus(2, 'loading', 'üì§ Sending test email...');
      try {
        const result = await makeRequest('test-assignment', {
          staffId: staffId,
          complaintId: 'CMP-TEST-' + Date.now()
        });
        
        if (result && result.success) {
          showStatus(2, 'success', `‚úÖ Email sent to ${result.email}`);
        } else {
          showStatus(2, 'error', '‚ùå Failed: ' + (result?.message || 'Unknown error'));
        }
      } catch (error) {
        showStatus(2, 'error', '‚ùå Error: ' + error.message);
      }
    }
    
    async function testUnassignment() {
      const staffId = document.getElementById('staffId').value;
      if (!staffId) {
        showStatus(3, 'error', '‚ùå Please enter Staff ID first!');
        return;
      }
      
      showStatus(3, 'loading', 'üì§ Sending test email...');
      try {
        const result = await makeRequest('test-unassignment', {
          staffId: staffId,
          complaintId: 'CMP-TEST-' + Date.now()
        });
        
        if (result && result.success) {
          showStatus(3, 'success', `‚úÖ Email sent to ${result.email}`);
        } else {
          showStatus(3, 'error', '‚ùå Failed: ' + (result?.message || 'Unknown error'));
        }
      } catch (error) {
        showStatus(3, 'error', '‚ùå Error: ' + error.message);
      }
    }
    
    async function testResolved() {
      const staffId = document.getElementById('staffId').value;
      if (!staffId) {
        showStatus(4, 'error', '‚ùå Please enter Staff ID first!');
        return;
      }
      
      showStatus(4, 'loading', 'üì§ Sending test email...');
      try {
        const result = await makeRequest('test-resolved', {
          staffId: staffId,
          complaintId: 'CMP-TEST-' + Date.now()
        });
        
        if (result && result.success) {
          showStatus(4, 'success', `‚úÖ Email sent to ${result.email}`);
        } else {
          showStatus(4, 'error', '‚ùå Failed: ' + (result?.message || 'Unknown error'));
        }
      } catch (error) {
        showStatus(4, 'error', '‚ùå Error: ' + error.message);
      }
    }
    
    async function testClosed() {
      const staffId = document.getElementById('staffId').value;
      if (!staffId) {
        showStatus(5, 'error', '‚ùå Please enter Staff ID first!');
        return;
      }
      
      showStatus(5, 'loading', 'üì§ Sending test email...');
      try {
        const result = await makeRequest('test-closed', {
          staffId: staffId,
          complaintId: 'CMP-TEST-' + Date.now()
        });
        
        if (result && result.success) {
          showStatus(5, 'success', `‚úÖ Email sent to ${result.email}`);
        } else {
          showStatus(5, 'error', '‚ùå Failed: ' + (result?.message || 'Unknown error'));
        }
      } catch (error) {
        showStatus(5, 'error', '‚ùå Error: ' + error.message);
      }
    }
    
    async function testReopened() {
      const staffId = document.getElementById('staffId').value;
      if (!staffId) {
        showStatus(6, 'error', '‚ùå Please enter Staff ID first!');
        return;
      }
      
      showStatus(6, 'loading', 'üì§ Sending test email...');
      try {
        const result = await makeRequest('test-reopened', {
          staffId: staffId,
          complaintId: 'CMP-TEST-' + Date.now()
        });
        
        if (result && result.success) {
          showStatus(6, 'success', `‚úÖ Email sent to ${result.email}`);
        } else {
          showStatus(6, 'error', '‚ùå Failed: ' + (result?.message || 'Unknown error'));
        }
      } catch (error) {
        showStatus(6, 'error', '‚ùå Error: ' + error.message);
      }
    }
    
    async function testAll() {
      if (!confirm('This will send 6 test emails. Continue?')) {
        return;
      }
      
      await testNewComplaint();
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      await testAssignment();
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      await testUnassignment();
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      await testResolved();
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      await testClosed();
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      await testReopened();
      
      alert('‚úÖ All tests completed! Check your email inbox.');
    }
  </script>
</body>
</html>
